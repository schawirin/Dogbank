# =============================================================================
# Docker Compose Full Stack - DogBank com Datadog APM
# =============================================================================
# Este arquivo sobe TUDO: Frontend + Backend + Banco de Dados + Datadog
#
# Servi√ßos inclu√≠dos:
# - PostgreSQL (banco de dados)
# - Redis (cache)
# - Datadog Agent (APM, m√©tricas, logs)
# - Auth Service (autentica√ß√£o)
# - Account Service (contas)
# - Transaction Service (transa√ß√µes PIX)
# - Banco Central Service (valida√ß√£o PIX)
# - Frontend (React + Nginx)
# - Nginx Gateway (proxy reverso)
#
# =============================================================================
# USO:
#   # Configurar API Key do Datadog
#   export DD_API_KEY="sua-api-key-aqui"
#   
#   docker-compose -f docker-compose.full.yml up -d
#
# PARAR TUDO:
#   docker-compose -f docker-compose.full.yml down
#
# LIMPAR TUDO (incluindo dados):
#   docker-compose -f docker-compose.full.yml down -v
#
# VER LOGS:
#   docker-compose -f docker-compose.full.yml logs -f
#
# =============================================================================

version: '3.8'

services:
  # ===========================================================================
  # üíæ BANCO DE DADOS - PostgreSQL
  # ===========================================================================
  
  postgres:
    image: postgres:15-alpine
    container_name: dogbank-postgres
    environment:
      POSTGRES_DB: dogbank
      POSTGRES_USER: dogbank
      POSTGRES_PASSWORD: dog1234
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db:/docker-entrypoint-initdb.d:ro
    command:
      - "postgres"
      - "-c"
      - "shared_preload_libraries=pg_stat_statements"
      - "-c"
      - "pg_stat_statements.max=10000"
      - "-c"
      - "pg_stat_statements.track=all"
      - "-c"
      - "track_activity_query_size=4096"
    networks:
      - dogbank-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dogbank -d dogbank"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    labels:
      com.datadoghq.ad.logs: '[{"source": "postgresql", "service": "dogbank-postgres"}]'

  # ===========================================================================
  # üî¥ CACHE - Redis
  # ===========================================================================
  
  redis:
    image: redis:7-alpine
    container_name: dogbank-redis
    command: redis-server --appendonly yes --maxmemory 128mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - dogbank-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    labels:
      com.datadoghq.ad.check_names: '["redisdb"]'
      com.datadoghq.ad.init_configs: '[{}]'
      com.datadoghq.ad.instances: '[{"host":"%%host%%", "port":"6379"}]'
      com.datadoghq.ad.logs: '[{"source": "redis", "service": "dogbank-redis"}]'

  # ===========================================================================
  # üêï DATADOG AGENT
  # ===========================================================================
  
  datadog-agent:
    image: gcr.io/datadoghq/agent:latest
    container_name: datadog-agent
    environment:
      # API Key (obrigat√≥rio)
      DD_API_KEY: ${DD_API_KEY:-}
      # Site do Datadog (us1.datadoghq.com para US, datadoghq.eu para EU)
      DD_SITE: ${DD_SITE:-datadoghq.com}
      # Hostname
      DD_HOSTNAME: dogbank-docker
      # APM
      DD_APM_ENABLED: "true"
      DD_APM_NON_LOCAL_TRAFFIC: "true"
      # Logs
      DD_LOGS_ENABLED: "true"
      DD_LOGS_CONFIG_CONTAINER_COLLECT_ALL: "true"
      # Process monitoring
      DD_PROCESS_AGENT_ENABLED: "true"
      # Container monitoring
      DD_CONTAINER_EXCLUDE: "name:datadog-agent"
      # Tags
      DD_TAGS: "env:dogbank project:dogbank"
      # Dogstatsd
      DD_DOGSTATSD_NON_LOCAL_TRAFFIC: "true"
      # Database Monitoring (DBM)
      DD_DBM_ENABLED: "true"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /proc/:/host/proc/:ro
      - /sys/fs/cgroup/:/host/sys/fs/cgroup:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - ./datadog/conf.d/postgres.d/conf.yaml:/etc/datadog-agent/conf.d/postgres.d/conf.yaml:ro
    ports:
      - "8126:8126"  # APM traces
      - "8125:8125/udp"  # DogStatsD
    networks:
      - dogbank-network
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

  # ===========================================================================
  # üèõÔ∏è BANCO CENTRAL SERVICE
  # ===========================================================================
  
  bancocentral-service:
    build:
      context: .
      dockerfile: dockerfiles/Dockerfile.bancocentral
    container_name: bancocentral-service
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/dogbank
      SPRING_DATASOURCE_USERNAME: dogbank
      SPRING_DATASOURCE_PASSWORD: dog1234
      SERVER_PORT: 8085
      # Datadog
      DD_AGENT_HOST: datadog-agent
      DD_SERVICE: bancocentral-service
      DD_ENV: dogbank
      DD_VERSION: "1.0.0"
    depends_on:
      postgres:
        condition: service_healthy
      datadog-agent:
        condition: service_started
    networks:
      - dogbank-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8085/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s
    restart: unless-stopped
    labels:
      com.datadoghq.ad.logs: '[{"source": "java", "service": "bancocentral-service"}]'

  # ===========================================================================
  # üîë AUTH SERVICE
  # ===========================================================================
  
  auth-service:
    build:
      context: .
      dockerfile: dockerfiles/Dockerfile.auth
    container_name: auth-service
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/dogbank
      SPRING_DATASOURCE_USERNAME: dogbank
      SPRING_DATASOURCE_PASSWORD: dog1234
      SPRING_REDIS_HOST: redis
      SPRING_REDIS_PORT: 6379
      SERVER_PORT: 8088
      JWT_SECRET: dogbank-secret-key-change-in-production
      JWT_EXPIRATION: 86400000
      # Datadog
      DD_AGENT_HOST: datadog-agent
      DD_SERVICE: auth-service
      DD_ENV: dogbank
      DD_VERSION: "1.0.0"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      datadog-agent:
        condition: service_started
    networks:
      - dogbank-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8088/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s
    restart: unless-stopped
    labels:
      com.datadoghq.ad.logs: '[{"source": "java", "service": "auth-service"}]'

  # ===========================================================================
  # üí≥ ACCOUNT SERVICE
  # ===========================================================================
  
  account-service:
    build:
      context: .
      dockerfile: dockerfiles/Dockerfile.account
    container_name: account-service
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/dogbank
      SPRING_DATASOURCE_USERNAME: dogbank
      SPRING_DATASOURCE_PASSWORD: dog1234
      SERVER_PORT: 8089
      # Datadog
      DD_AGENT_HOST: datadog-agent
      DD_SERVICE: account-service
      DD_ENV: dogbank
      DD_VERSION: "1.0.0"
    depends_on:
      postgres:
        condition: service_healthy
      auth-service:
        condition: service_healthy
      datadog-agent:
        condition: service_started
    networks:
      - dogbank-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8089/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s
    restart: unless-stopped
    labels:
      com.datadoghq.ad.logs: '[{"source": "java", "service": "account-service"}]'

  # ===========================================================================
  # üí∏ TRANSACTION SERVICE
  # ===========================================================================
  
  transaction-service:
    build:
      context: .
      dockerfile: dockerfiles/Dockerfile.transaction
    container_name: transaction-service
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/dogbank
      SPRING_DATASOURCE_USERNAME: dogbank
      SPRING_DATASOURCE_PASSWORD: dog1234
      SERVER_PORT: 8084
      BANCOCENTRAL_API_URL: http://bancocentral-service:8085/api/bancocentral
      ACCOUNT_SERVICE_URL: http://account-service:8089
      # Datadog
      DD_AGENT_HOST: datadog-agent
      DD_SERVICE: transaction-service
      DD_ENV: dogbank
      DD_VERSION: "1.0.0"
    depends_on:
      postgres:
        condition: service_healthy
      bancocentral-service:
        condition: service_healthy
      account-service:
        condition: service_healthy
      datadog-agent:
        condition: service_started
    networks:
      - dogbank-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8084/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s
    restart: unless-stopped
    labels:
      com.datadoghq.ad.logs: '[{"source": "java", "service": "transaction-service"}]'


  # ===========================================================================
  # ü§ñ CHATBOT SERVICE - Assistente Virtual com LLM
  # ===========================================================================
  # ‚ö†Ô∏è VULNER√ÅVEL A PROMPT INJECTION - PROPOSITAL PARA DEMO
  # ===========================================================================
  
  chatbot-service:
    build:
      context: ./chatbot-python
      dockerfile: Dockerfile
    container_name: chatbot-service
    environment:
      # =================================================================
      # LLM Configuration - Choose your provider:
      # =================================================================
      # QWEN (Alibaba) - Default, free tier available
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}  # Get from https://bailian.console.aliyun.com/
      OPENAI_API_BASE_URL: ${OPENAI_API_BASE_URL:-https://dashscope.aliyuncs.com/compatible-mode/v1}
      OPENAI_MODEL: ${OPENAI_MODEL:-qwen-turbo}  # qwen-turbo, qwen-plus, qwen-max
      # 
      # Alternative providers (uncomment to use):
      # GROQ - Fast inference, free tier
      # OPENAI_API_BASE_URL: https://api.groq.com/openai/v1
      # OPENAI_MODEL: llama-3.1-8b-instant
      #
      # OPENAI - Original
      # OPENAI_API_BASE_URL: https://api.openai.com/v1
      # OPENAI_MODEL: gpt-4o-mini
      #
      # OLLAMA - Local (requires ollama service)
      # OPENAI_API_BASE_URL: http://ollama:11434/v1
      # OPENAI_MODEL: llama3.2:1b
      # =================================================================
      # Service URLs
      ACCOUNT_SERVICE_URL: http://account-service:8089
      TRANSACTION_SERVICE_URL: http://transaction-service:8087
      AUTH_SERVICE_URL: http://auth-service:8088
      # Datadog APM
      DD_AGENT_HOST: datadog-agent
      DD_TRACE_AGENT_PORT: 8126
      DD_ENV: dogbank
      DD_SERVICE: chatbot-service
      DD_VERSION: "2.0.0"
      DD_LOGS_INJECTION: "true"
      DD_PROFILING_ENABLED: "true"
      # Datadog LLM Observability
      DD_LLMOBS_ENABLED: "1"
      DD_LLMOBS_ML_APP: "dogbot-assistant"
      DD_LLMOBS_AGENTLESS_ENABLED: "false"
      DD_SITE: ${DD_SITE:-datadoghq.com}
    depends_on:
      datadog-agent:
        condition: service_healthy
      # Uncomment if using Ollama:
      # ollama:
      #   condition: service_healthy
    networks:
      - dogbank-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8083/api/chatbot/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    labels:
      com.datadoghq.ad.logs: '[{"source": "python", "service": "chatbot-service"}]'


  # ===========================================================================
  # ü§ñ OLLAMA - Local LLM Server
  # ===========================================================================
  
  ollama:
    image: ollama/ollama:latest
    container_name: dogbank-ollama
    entrypoint: ["/bin/bash", "/entrypoint.sh"]
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
      - ./ollama-entrypoint.sh:/entrypoint.sh:ro
    environment:
      # Model to auto-pull on startup
      OLLAMA_MODEL: ${OLLAMA_MODEL:-llama3.2:1b}
      # Minimal memory usage
      OLLAMA_NUM_PARALLEL: 1
      OLLAMA_MAX_LOADED_MODELS: 1
    networks:
      - dogbank-network
    healthcheck:
      # Check if model is loaded (not just server running)
      test: ["CMD-SHELL", "curl -s http://localhost:11434/api/tags | grep -q llama || curl -s http://localhost:11434/api/tags | grep -q phi || curl -s http://localhost:11434/api/tags | grep -q qwen || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 120s
    restart: unless-stopped
    labels:
      com.datadoghq.ad.logs: '[{"source": "ollama", "service": "ollama"}]'
    # Uncomment for GPU support (NVIDIA)
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]

  # ===========================================================================
  # üåê FRONTEND - React + Nginx
  # ===========================================================================
  
  frontend:
    build:
      context: ../dogbank-frontend
      dockerfile: Dockerfile
    container_name: dogbank-frontend
    networks:
      - dogbank-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    labels:
      com.datadoghq.ad.logs: '[{"source": "nginx", "service": "dogbank-frontend"}]'

  # ===========================================================================
  # üö™ NGINX GATEWAY - Proxy Reverso
  # ===========================================================================
  
  nginx:
    image: nginx:stable-alpine
    container_name: dogbank-nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx-gateway.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - frontend
      - auth-service
      - account-service
      - transaction-service
      - bancocentral-service
    networks:
      - dogbank-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    labels:
      com.datadoghq.ad.check_names: '["nginx"]'
      com.datadoghq.ad.init_configs: '[{}]'
      com.datadoghq.ad.instances: '[{"nginx_status_url": "http://%%host%%:80/nginx_status"}]'
      com.datadoghq.ad.logs: '[{"source": "nginx", "service": "dogbank-nginx"}]'

# =============================================================================
# üåê NETWORKS
# =============================================================================

networks:
  dogbank-network:
    driver: bridge

# =============================================================================
# üíæ VOLUMES
# =============================================================================

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  ollama_data:
    driver: local
