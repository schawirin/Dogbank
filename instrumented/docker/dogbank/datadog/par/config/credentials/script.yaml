# =============================================================================
# DogBank - Private Action Runner - Allowlist de Comandos
# =============================================================================
# IMPORTANTE: Apenas comandos listados aqui podem ser executados!
# Isso garante seguranca e previne execucao de comandos arbitrarios.
#
# Docs: https://docs.datadoghq.com/actions/private_actions/run_script/
# =============================================================================

allowedCommands:
  # ===========================================================================
  # Restart de Servicos Individuais
  # ===========================================================================
  - name: restart_transaction_service
    command: docker-compose -f /dogbank/docker-compose.full.yml restart transaction-service
    description: "Reinicia o transaction-service (PIX/transacoes)"
    timeout: 60s

  - name: restart_pix_worker
    command: docker-compose -f /dogbank/docker-compose.full.yml restart pix-worker
    description: "Reinicia o pix-worker (processador Kafka)"
    timeout: 60s

  - name: restart_auth_service
    command: docker-compose -f /dogbank/docker-compose.full.yml restart auth-service
    description: "Reinicia o auth-service (autenticacao)"
    timeout: 60s

  - name: restart_chatbot_service
    command: docker-compose -f /dogbank/docker-compose.full.yml restart chatbot-service
    description: "Reinicia o chatbot-service (LLM)"
    timeout: 120s

  - name: restart_account_service
    command: docker-compose -f /dogbank/docker-compose.full.yml restart account-service
    description: "Reinicia o account-service (contas)"
    timeout: 60s

  - name: restart_bancocentral_service
    command: docker-compose -f /dogbank/docker-compose.full.yml restart bancocentral-service
    description: "Reinicia o bancocentral-service (simulador BACEN)"
    timeout: 60s

  - name: restart_fraud_detection
    command: docker-compose -f /dogbank/docker-compose.full.yml restart fraud-detection-service
    description: "Reinicia o fraud-detection-service"
    timeout: 60s

  # ===========================================================================
  # Scaling de Servicos
  # ===========================================================================
  - name: scale_pix_worker_3
    command: docker-compose -f /dogbank/docker-compose.full.yml up -d --scale pix-worker=3
    description: "Escala pix-worker para 3 replicas"
    timeout: 120s

  - name: scale_pix_worker_5
    command: docker-compose -f /dogbank/docker-compose.full.yml up -d --scale pix-worker=5
    description: "Escala pix-worker para 5 replicas"
    timeout: 120s

  - name: scale_pix_worker_1
    command: docker-compose -f /dogbank/docker-compose.full.yml up -d --scale pix-worker=1
    description: "Reduz pix-worker para 1 replica (normalizar)"
    timeout: 60s

  # ===========================================================================
  # Restart em Grupo
  # ===========================================================================
  - name: restart_all_backend
    command: docker-compose -f /dogbank/docker-compose.full.yml restart transaction-service auth-service account-service pix-worker
    description: "Reinicia todos os servicos backend principais"
    timeout: 180s

  - name: restart_messaging
    command: docker-compose -f /dogbank/docker-compose.full.yml restart kafka zookeeper rabbitmq
    description: "Reinicia servicos de mensageria (Kafka, RabbitMQ)"
    timeout: 180s

  # ===========================================================================
  # Health Checks e Diagnostico
  # ===========================================================================
  - name: check_services_status
    command: docker-compose -f /dogbank/docker-compose.full.yml ps
    description: "Lista status de todos os containers"
    timeout: 30s

  - name: check_service_logs_transaction
    command: docker-compose -f /dogbank/docker-compose.full.yml logs --tail=100 transaction-service
    description: "Mostra ultimas 100 linhas de logs do transaction-service"
    timeout: 30s

  - name: check_service_logs_pix_worker
    command: docker-compose -f /dogbank/docker-compose.full.yml logs --tail=100 pix-worker
    description: "Mostra ultimas 100 linhas de logs do pix-worker"
    timeout: 30s

  - name: check_service_logs_auth
    command: docker-compose -f /dogbank/docker-compose.full.yml logs --tail=100 auth-service
    description: "Mostra ultimas 100 linhas de logs do auth-service"
    timeout: 30s

  - name: check_kafka_topics
    command: docker-compose -f /dogbank/docker-compose.full.yml exec -T kafka kafka-topics --list --bootstrap-server localhost:9092
    description: "Lista topics do Kafka"
    timeout: 30s

  # ===========================================================================
  # CUIDADO: Comandos mais agressivos
  # ===========================================================================
  - name: force_recreate_transaction_service
    command: docker-compose -f /dogbank/docker-compose.full.yml up -d --force-recreate transaction-service
    description: "Forca recriacao do container transaction-service"
    timeout: 120s

  - name: force_recreate_pix_worker
    command: docker-compose -f /dogbank/docker-compose.full.yml up -d --force-recreate pix-worker
    description: "Forca recriacao do container pix-worker"
    timeout: 120s
