#!/bin/bash
# =============================================================================
# DogBank Secrets - Template
# =============================================================================
# INSTRUCTIONS: 
# 1. Copy this file: cp secrets.local.sh.example secrets.local.sh
# 2. Edit secrets.local.sh and fill in real values
# 3. Execute: ./secrets.local.sh
# 4. NEVER commit secrets.local.sh!
# =============================================================================

# Database
export POSTGRES_PASSWORD="YOUR_POSTGRES_PASSWORD_HERE"
export DB_PASSWORD="YOUR_DB_PASSWORD_HERE"

# Datadog (get from: https://app.datadoghq.com/organization-settings/api-keys)
export DD_API_KEY="YOUR_DD_API_KEY_HERE"
export DD_APP_KEY="YOUR_DD_APP_KEY_HERE"
export DD_CLIENT_TOKEN="YOUR_DD_CLIENT_TOKEN_HERE"
export DD_APPLICATION_ID="YOUR_DD_APPLICATION_ID_HERE"

# JWT Secret (generate with: openssl rand -base64 64)
export JWT_SECRET="YOUR_JWT_SECRET_HERE"

# Groq (get from: https://console.groq.com/keys)
export GROQ_API_KEY="YOUR_GROQ_API_KEY_HERE"

# RabbitMQ
export RABBITMQ_PASSWORD="YOUR_RABBITMQ_PASSWORD_HERE"

# Datadog Database User
export DATADOG_DB_PASSWORD="YOUR_DATADOG_DB_PASSWORD_HERE"

# =============================================================================
# Create Secrets in Kubernetes
# =============================================================================

echo "üîê Creating secrets in Kubernetes..."

# Configure kubectl
aws eks update-kubeconfig --region us-east-1 --name eks-sandbox-datadog

# Create namespace if it doesn't exist
kubectl create namespace dogbank --dry-run=client -o yaml | kubectl apply -f -

# Delete existing secrets (if any)
kubectl delete secret dogbank-secrets -n dogbank --ignore-not-found
kubectl delete secret postgres-secrets -n dogbank --ignore-not-found

# Create main secret
kubectl create secret generic dogbank-secrets -n dogbank \
  --from-literal=POSTGRES_PASSWORD="${POSTGRES_PASSWORD}" \
  --from-literal=SPRING_DATASOURCE_PASSWORD="${POSTGRES_PASSWORD}" \
  --from-literal=db-user="dogbank" \
  --from-literal=db-password="${DB_PASSWORD}" \
  --from-literal=DD_API_KEY="${DD_API_KEY}" \
  --from-literal=DD_APP_KEY="${DD_APP_KEY}" \
  --from-literal=dd-api-key="${DD_API_KEY}" \
  --from-literal=VITE_DD_CLIENT_TOKEN="${DD_CLIENT_TOKEN}" \
  --from-literal=VITE_DD_APPLICATION_ID="${DD_APPLICATION_ID}" \
  --from-literal=JWT_SECRET="${JWT_SECRET}" \
  --from-literal=groq-api-key="${GROQ_API_KEY}" \
  --from-literal=rabbitmq-user="dogbank" \
  --from-literal=rabbitmq-password="${RABBITMQ_PASSWORD}" \
  --from-literal=dd-site="datadoghq.com"

echo "‚úÖ Secret 'dogbank-secrets' created"

# Create PostgreSQL secret
kubectl create secret generic postgres-secrets -n dogbank \
  --from-literal=POSTGRES_PASSWORD="${POSTGRES_PASSWORD}" \
  --from-literal=DATADOG_PASSWORD="${DATADOG_DB_PASSWORD}"

echo "‚úÖ Secret 'postgres-secrets' created"

# Verify
echo ""
echo "üìã Secrets created:"
kubectl get secrets -n dogbank

echo ""
echo "‚úÖ Secrets configured successfully!"
echo ""
echo "Next steps:"
echo "  1. Deploy the application: kubectl apply -f base/"
echo "  2. Verify pods are running: kubectl get pods -n dogbank"
