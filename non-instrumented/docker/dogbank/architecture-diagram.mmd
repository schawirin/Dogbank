%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#1a1a2e', 'primaryTextColor': '#fff', 'primaryBorderColor': '#00d9ff', 'lineColor': '#00d9ff', 'secondaryColor': '#16213e', 'tertiaryColor': '#0f3460', 'background': '#0a0a0a', 'mainBkg': '#1a1a2e', 'nodeBorder': '#00d9ff', 'clusterBkg': '#16213e', 'clusterBorder': '#00d9ff', 'titleColor': '#00d9ff', 'edgeLabelBackground': '#1a1a2e'}}}%%

flowchart TB
    subgraph CLIENTS["ğŸŒ CLIENTS"]
        direction LR
        WEB["ğŸ–¥ï¸ Web App<br/>(React)"]
        MOBILE["ğŸ“± Mobile App"]
        API_CLIENT["ğŸ”Œ API Client"]
    end

    subgraph GATEWAY["ğŸ”’ API GATEWAY (Nginx)"]
        direction TB
        HTTP["HTTP :80<br/>â†“ Redirect"]
        HTTPS["HTTPS :443<br/>TLS 1.2/1.3 | HTTP/2"]
        
        subgraph SECURITY["ğŸ›¡ï¸ Security Layer"]
            RATE["â±ï¸ Rate Limiting<br/>Login: 5/min<br/>Transactions: 30/min"]
            HEADERS["ğŸ“‹ Security Headers<br/>HSTS | CSP | X-Frame"]
            CORS["ğŸ”— CORS<br/>Origin Validation"]
        end
        
        SSL["ğŸ” SSL/TLS<br/>Certificates"]
    end

    subgraph MICROSERVICES["âš™ï¸ MICROSERVICES"]
        direction TB
        
        subgraph AUTH_GROUP["ğŸ”‘ Authentication"]
            AUTH["Auth Service<br/>:8088<br/>â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Login/Logout<br/>â€¢ User Management<br/>â€¢ Password Validation"]
        end
        
        subgraph CORE_BANKING["ğŸ’° Core Banking"]
            ACCOUNT["Account Service<br/>:8089<br/>â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Account CRUD<br/>â€¢ Balance Management<br/>â€¢ User Accounts"]
            
            TRANSACTION["Transaction Service<br/>:8084<br/>â”â”â”â”â”â”â”â”â”â”<br/>â€¢ PIX Transfers<br/>â€¢ Transaction History<br/>â€¢ âš ï¸ SQL Injection Demo"]
        end
        
        subgraph NEW_MODULES["ğŸ†• New Modules"]
            AUTORIZADOR["Autorizador Service<br/>:8090<br/>â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Transaction Authorization<br/>â€¢ Fraud Detection<br/>â€¢ Limit Validation"]
            
            LEDGER["Ledger Service<br/>:8091<br/>â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Double-Entry Bookkeeping<br/>â€¢ Account Balances<br/>â€¢ Audit Trail"]
        end
        
        subgraph EXTERNAL_INT["ğŸŒ External Integration"]
            BANCOCENTRAL["Banco Central Service<br/>:8085<br/>â”â”â”â”â”â”â”â”â”â”<br/>â€¢ PIX Validation<br/>â€¢ Central Bank API<br/>â€¢ Compliance"]
            
            INTEGRATION["Integration Service<br/>:8082<br/>â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Datadog Metrics<br/>â€¢ External APIs<br/>â€¢ Monitoring"]
        end
        
        subgraph SUPPORT["ğŸ“¢ Support Services"]
            NOTIFICATION["Notification Service<br/>:8083<br/>â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Email/SMS<br/>â€¢ Push Notifications<br/>â€¢ Alerts"]
        end
    end

    subgraph DATA["ğŸ’¾ DATA LAYER"]
        direction LR
        POSTGRES[("ğŸ˜ PostgreSQL<br/>:5432<br/>â”â”â”â”â”â”â”â”â”â”<br/>â€¢ usuarios<br/>â€¢ contas<br/>â€¢ transacoes_pix<br/>â€¢ ledger_entries")]
        
        REDIS[("âš¡ Redis<br/>:6379<br/>â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Session Cache<br/>â€¢ Rate Limit State<br/>â€¢ Temp Data")]
    end

    subgraph OBSERVABILITY["ğŸ“Š OBSERVABILITY"]
        direction LR
        DATADOG["ğŸ• Datadog<br/>â”â”â”â”â”â”â”â”â”â”<br/>â€¢ APM<br/>â€¢ Logs<br/>â€¢ Metrics<br/>â€¢ ASM"]
        
        LOGS["ğŸ“ Nginx Logs<br/>â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Access Logs<br/>â€¢ Error Logs"]
    end

    %% Client Connections
    WEB -->|"HTTPS"| HTTPS
    MOBILE -->|"HTTPS"| HTTPS
    API_CLIENT -->|"HTTPS"| HTTPS
    
    %% HTTP Redirect
    HTTP -.->|"301 Redirect"| HTTPS
    
    %% Gateway to Security
    HTTPS --> SECURITY
    HTTPS --> SSL
    
    %% Gateway to Services
    SECURITY -->|"/api/auth/*"| AUTH
    SECURITY -->|"/api/accounts/*"| ACCOUNT
    SECURITY -->|"/api/transactions/*"| TRANSACTION
    SECURITY -->|"/api/autorizador/*"| AUTORIZADOR
    SECURITY -->|"/api/ledger/*"| LEDGER
    SECURITY -->|"/api/bancocentral/*"| BANCOCENTRAL
    SECURITY -->|"/api/integration/*"| INTEGRATION
    SECURITY -->|"/api/notifications/*"| NOTIFICATION

    %% Service Dependencies
    AUTH -->|"User Data"| POSTGRES
    ACCOUNT -->|"Account Data"| POSTGRES
    TRANSACTION -->|"Transaction Data"| POSTGRES
    AUTORIZADOR -->|"Authorization Rules"| POSTGRES
    LEDGER -->|"Ledger Entries"| POSTGRES
    BANCOCENTRAL -->|"PIX Data"| POSTGRES
    NOTIFICATION -->|"Notification Log"| POSTGRES
    
    %% Inter-service Communication
    TRANSACTION -->|"Validate PIX"| BANCOCENTRAL
    TRANSACTION -->|"Authorize"| AUTORIZADOR
    TRANSACTION -->|"Record Entry"| LEDGER
    TRANSACTION -->|"Update Balance"| ACCOUNT
    TRANSACTION -->|"Send Alert"| NOTIFICATION
    
    AUTORIZADOR -->|"Check Limits"| ACCOUNT
    AUTORIZADOR -->|"Fraud Check"| INTEGRATION
    
    LEDGER -->|"Balance Update"| ACCOUNT
    
    %% Cache connections
    AUTH -.->|"Session"| REDIS
    AUTORIZADOR -.->|"Rate State"| REDIS
    
    %% Observability
    AUTH -.->|"Metrics"| DATADOG
    TRANSACTION -.->|"Metrics"| DATADOG
    AUTORIZADOR -.->|"Metrics"| DATADOG
    LEDGER -.->|"Metrics"| DATADOG
    INTEGRATION -->|"Send Metrics"| DATADOG
    HTTPS -.->|"Access Logs"| LOGS

    %% Styling
    classDef clientStyle fill:#2d3436,stroke:#00d9ff,stroke-width:2px,color:#fff
    classDef gatewayStyle fill:#0984e3,stroke:#00d9ff,stroke-width:2px,color:#fff
    classDef serviceStyle fill:#6c5ce7,stroke:#00d9ff,stroke-width:2px,color:#fff
    classDef newServiceStyle fill:#00b894,stroke:#00d9ff,stroke-width:3px,color:#fff
    classDef dataStyle fill:#d63031,stroke:#00d9ff,stroke-width:2px,color:#fff
    classDef obsStyle fill:#fdcb6e,stroke:#00d9ff,stroke-width:2px,color:#000
    classDef securityStyle fill:#e17055,stroke:#00d9ff,stroke-width:2px,color:#fff

    class WEB,MOBILE,API_CLIENT clientStyle
    class HTTP,HTTPS,SSL gatewayStyle
    class RATE,HEADERS,CORS securityStyle
    class AUTH,ACCOUNT,TRANSACTION,BANCOCENTRAL,INTEGRATION,NOTIFICATION serviceStyle
    class AUTORIZADOR,LEDGER newServiceStyle
    class POSTGRES,REDIS dataStyle
    class DATADOG,LOGS obsStyle
