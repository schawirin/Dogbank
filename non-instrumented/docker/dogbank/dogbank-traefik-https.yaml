---
# =====================================================
# DOGBANK - TRAEFIK HTTPS COM LET'S ENCRYPT
# =====================================================
# Domínio: lab.dogbank.com
# Certificado: Let's Encrypt (auto-renovação)
# =====================================================

---
# PersistentVolumeClaim para armazenar certificados Let's Encrypt
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: traefik-acme-pvc
  namespace: kube-system
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi

---
# ConfigMap: Configuração do Traefik para Let's Encrypt
apiVersion: v1
kind: ConfigMap
metadata:
  name: traefik-config
  namespace: kube-system
data:
  traefik.yaml: |
    global:
      checkNewVersion: false
      sendAnonymousUsage: false

    # Entrypoints - HTTP e HTTPS
    entryPoints:
      web:
        address: ":80"
        http:
          redirections:
            entryPoint:
              to: websecure
              scheme: https
              permanent: true
      websecure:
        address: ":443"

    # API Dashboard
    api:
      dashboard: true
      insecure: true

    # Kubernetes Providers
    providers:
      kubernetesCRD:
        ingressClass: traefik
        allowCrossNamespace: true
        allowEmptyServices: true
      kubernetesIngress:
        ingressClass: traefik
        allowEmptyServices: true

    # Let's Encrypt Configuration
    certificatesResolvers:
      letsencrypt:
        acme:
          # IMPORTANTE: Use seu email real aqui
          email: admin@dogbank.com
          storage: /acme/acme.json

          # HTTP Challenge (porta 80)
          httpChallenge:
            entryPoint: web

          # PRODUÇÃO - Let's Encrypt (descomente depois de testar)
          # caServer: https://acme-v02.api.letsencrypt.org/directory

          # STAGING - Para testes sem rate limit (comente em produção)
          caServer: https://acme-staging-v02.api.letsencrypt.org/directory

    # Logs
    log:
      level: INFO

    # Access logs
    accessLog: {}

---
# Traefik Deployment - com volume para certificados
apiVersion: apps/v1
kind: Deployment
metadata:
  name: traefik
  namespace: kube-system
  labels:
    app: traefik
spec:
  replicas: 1
  selector:
    matchLabels:
      app: traefik
  template:
    metadata:
      labels:
        app: traefik
    spec:
      serviceAccountName: traefik
      containers:
        - name: traefik
          image: traefik:v2.10
          args:
            - --configfile=/config/traefik.yaml
          ports:
            - name: web
              containerPort: 80
            - name: websecure
              containerPort: 443
            - name: admin
              containerPort: 8080
          volumeMounts:
            - name: config
              mountPath: /config
            - name: acme
              mountPath: /acme
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "256Mi"
              cpu: "200m"
      volumes:
        - name: config
          configMap:
            name: traefik-config
        - name: acme
          persistentVolumeClaim:
            claimName: traefik-acme-pvc

---
# Traefik Service - LoadBalancer
apiVersion: v1
kind: Service
metadata:
  name: traefik
  namespace: kube-system
spec:
  type: LoadBalancer
  selector:
    app: traefik
  ports:
    - name: web
      port: 80
      targetPort: 80
      protocol: TCP
    - name: websecure
      port: 443
      targetPort: 443
      protocol: TCP
    - name: admin
      port: 8080
      targetPort: 8080
      protocol: TCP

---
# Middleware: CORS Headers
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: cors-headers
  namespace: production
spec:
  headers:
    accessControlAllowOriginList:
      - "http://localhost:3000"
      - "https://lab.dogbank.com"
      - "http://lab.dogbank.com"
    accessControlAllowMethods:
      - "GET"
      - "POST"
      - "PUT"
      - "DELETE"
      - "OPTIONS"
      - "PATCH"
      - "HEAD"
    accessControlAllowHeaders:
      - "*"
    accessControlAllowCredentials: false
    accessControlMaxAge: 3600
    accessControlExposeHeaders:
      - "*"

---
# IngressRoute: Backend APIs com HTTPS
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: backend-apis-https
  namespace: production
spec:
  entryPoints:
    - websecure
  routes:
    - match: Host(`lab.dogbank.com`) && PathPrefix(`/api/auth`)
      kind: Rule
      services:
        - name: auth-service
          port: 8088
      middlewares:
        - name: cors-headers
      priority: 100

    - match: Host(`lab.dogbank.com`) && PathPrefix(`/api/accounts`)
      kind: Rule
      services:
        - name: accounts-service
          port: 8089
      middlewares:
        - name: cors-headers
      priority: 100

    - match: Host(`lab.dogbank.com`) && PathPrefix(`/api/transactions`)
      kind: Rule
      services:
        - name: transactions-service
          port: 8084
      middlewares:
        - name: cors-headers
      priority: 100

    - match: Host(`lab.dogbank.com`) && PathPrefix(`/api/bancocentral`)
      kind: Rule
      services:
        - name: bancocentral-service
          port: 8085
      middlewares:
        - name: cors-headers
      priority: 100

    - match: Host(`lab.dogbank.com`) && PathPrefix(`/api/integration`)
      kind: Rule
      services:
        - name: integration-service
          port: 8082
      middlewares:
        - name: cors-headers
      priority: 100

    - match: Host(`lab.dogbank.com`) && PathPrefix(`/api/notifications`)
      kind: Rule
      services:
        - name: notifications-service
          port: 8083
      middlewares:
        - name: cors-headers
      priority: 100

  # TLS com Let's Encrypt
  tls:
    certResolver: letsencrypt
    domains:
      - main: lab.dogbank.com

---
# IngressRoute: Frontend com HTTPS
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: frontend-https
  namespace: production
spec:
  entryPoints:
    - websecure
  routes:
    - match: Host(`lab.dogbank.com`) && PathPrefix(`/`)
      kind: Rule
      services:
        - name: dogbank-frontend-service
          port: 80
      priority: 1

  # TLS com Let's Encrypt
  tls:
    certResolver: letsencrypt
    domains:
      - main: lab.dogbank.com
